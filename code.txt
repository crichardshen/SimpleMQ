package com.example.messaging.controller;

import com.example.messaging.core.hub.MessageHub;
import com.example.messaging.core.model.ProtocolType;
import com.example.messaging.core.model.RawMessage;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.UUID;

/**
 * HTTP消息接收控制器
 */
@Slf4j
@RestController
@RequestMapping("/api/messages")
public class HttpMessageController {
    private final MessageHub messageHub;
    
    @Autowired
    public HttpMessageController(MessageHub messageHub) {
        this.messageHub = messageHub;
    }
    
    @PostMapping
    public String receiveMessage(@RequestBody byte[] data, 
                               @RequestHeader("X-Client-Id") String clientId) {
        RawMessage message = new RawMessage();
        message.setClientId(clientId);
        message.setProtocol(ProtocolType.HTTP);
        message.setRawData(data);
        message.setTimestamp(System.currentTimeMillis());
        message.setSessionId(UUID.randomUUID().toString());
        
        messageHub.addClientMessage(message);
        log.info("Received HTTP message from client: {}", clientId);
        
        return "Message accepted";
    }
}