1. 功能性用户故事 (Functional User Stories)
消息接收与处理
=============
US001 - 接收外部系统消息
**作为** ATMH/JETCO/EPSCO 系统  
**我希望** 能够将消息发送到任意一个可用的 SimpleMQ 服务器  
**以便** 消息能够被可靠地传递到目标系统  
**验收标准**：  
- 支持socket接入  
- 返回明确的成功/失败响应（如 HTTP 200/500）  

US002 - 消息内容不变性保证
**作为** 业务系统（如 ATMH）  
**我希望** SimpleMQ 不会修改消息的内容或格式  
**以便** 消息在传输过程中保持原始语义  
**验收标准**：  
- 输出消息与输入消息的二进制内容完全一致  
- 消息头（如 MessageID）不被篡改  

US003 - 消息验证
**作为** SimpleMQ 运维团队  
**我希望** MQ 能基于消息头长度验证消息体  
**以便** 防止粘连消息进入系统  
**验收标准**：  
- 消息头长度不符合约定时，MQ应拒绝消息并返回错误码  
- 错误日志需包含消息ID和失败原因  
消息分发与故障转移

US004 - 轮询选择 MQ 服务器
**作为** 外部系统（如 JETCO）  
**我希望** 能按轮询策略选择连接 SimpleMQ 的 A 或 B 服务器  
**以便** 实现简单的负载均衡  
**验收标准**：  
- 外部系统依次交替连接 A/B 节点（如 A→B→A→B）  
- 节点选择逻辑由外部系统实现，MQ不干预  

US005 - 自动故障转移
**作为** 外部系统（如 EPSCO）  
**我希望** 在连接一个 SimpleMQ 服务器失败时，自动尝试另一个  
**以便** 保证消息传输的高可用性  
**验收标准**：  
- 首次连接失败后，5秒内重试另一节点  
- 最多重试3次，全部失败后抛出异常  
- 适用于 MQ→外部系统的连接故障转移  

US006 - 支持多种分发策略（未来扩展）
**作为** 系统管理员  
**我希望** 可以配置不同的消息分发策略（如轮询、随机、主主等）  
**以便** 适应不同的业务场景  
**验收标准**：  
- 默认策略为轮询  
- 可通过配置文件切换策略  

存储与日志
=============
US007 - 消息本地存储（JSON 文件）
**作为** 运维人员  
**我希望** 所有消息都按日期存储为本地 JSON 文件  
**以便** 后续审计和问题排查  
**验收标准**：  
- 存储路径格式：`/data/messages/{YYYYMMDD}/{HH}/{MessageID}.json`  
- 文件内容包含完整消息头和消息体  

US008 - 日志记录与监控
**作为** 技术支持团队  
**我希望** SimpleMQ 记录关键操作日志（如消息接收、分发、错误）  
**以便** 快速定位问题  
**验收标准**：  
- 日志级别：ERROR（失败操作）、WARN（重试）、INFO（关键步骤）  
- 日志字段包含：时间戳、消息ID、操作类型、状态码  

US009 - 自动清理旧数据
**作为** 系统管理员  
**我希望** SimpleMQ 自动清理超过 7 天的消息文件  
**以便** 节省存储空间  
**验收标准**：  
- 每日凌晨1点执行清理任务  
- 删除7天前的 `/data/messages/` 子目录  

2. 非功能性用户故事 (Non-Functional User Stories)
性能与可靠性
=============
NF001 - 高吞吐量支持
**作为** 业务用户  
**我希望** SimpleMQ 能处理峰值12条消息/秒（约300万条/周）  
**以便** 满足业务高峰期需求  
**验收标准**：  
- 在持续1小时峰值负载下，P99延迟<500ms  
- 消息积压量不超过1000条  

NF002 - 7x24 可用性
**作为** 业务方  
**我希望** SimpleMQ 能在服务器维护外的时间保持可用  
**以便** 不影响正常业务运行  
**验收标准**：  
- 每月计划内维护窗口≤2小时（需提前通知）  
- 全年非计划停机时间<99.9%  

安全与维护
=============
NF003 - 仅允许 CONEGW 程序访问
**作为** 安全管理员  
**我希望** SimpleMQ 仅接受来自 CONEGW 内部系统的连接  
**以便** 防止未授权访问  
**验收标准**：  
- 通过IP白名单限制访问（如 10.0.0.0/8）  
- 非法连接尝试记录到安全日志  

NF004 - 无单点故障
**作为** 架构师  
**我希望** 两个 SimpleMQ 服务器能同时工作，避免单点故障  
**以便** 提高系统可靠性  
**验收标准**：  
- 任意单节点故障不影响整体服务  
- 故障节点恢复后自动重新加入服务池  